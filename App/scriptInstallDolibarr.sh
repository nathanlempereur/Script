#!/bin/bash 

echo "
*************************************************************************************
*************************************************************************************
********************************Installation de Apache2 Server***********************
*************************************************************************************
*************************************************************************************
"

./scriptInstallApache2.sh


echo "
*************************************************************************************
*************************************************************************************
********************************Recuperation du Dolibarr*****************************
*************************************************************************************
*************************************************************************************
"
apt install -y wget zip

wget https://www.pedagogeek.fr/cours/vm/WebApps/dolibarr-20.0.2.zip

unzip dolibarr-20.0.2.zip

rm dolibarr-20.0.2.zip

mv dolibarr-20.0.2 /var/www/

if [[ $? -eq 0 ]]; then
    echo "
*************************************************************************************
********************************Extraction vers /var/www/ OK !***********************
*************************************************************************************
"
else
    echo "
*************************************************************************************
********************************Erreur dans l extraction*****************************
*************************************************************************************
"
    exit 0
fi


echo "
*************************************************************************************
*************************************************************************************
********************************Configuration du site********************************
*************************************************************************************
*************************************************************************************
"

a2dissite 000-default.conf

echo "
<VirtualHost *:80>
	ServerAdmin webmaster@localhost
	DocumentRoot /var/www/dolibarr-20.0.2/htdocs
	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined
	
	<Directory /var/www/dolibarr-20.0.2>
		Options Indexes FollowSymLinks
		Require all granted
	</Directory>
</VirtualHost>" > /etc/apache2/sites-available/dolibarr.conf

a2ensite dolibarr.conf

chown -R www-data:www-data /var/www/dolibarr-20.0.2

mysql -u root -e "
CREATE DATABASE dolibarr;
GRANT ALL PRIVILEGES ON dolibarr.* TO 'DBR1'@'localhost' IDENTIFIED BY 'btsinfo';
FLUSH PRIVILEGES;
"

systemctl restart apache2


if [[ $? -eq 0 ]]; then
    echo "
*************************************************************************************
*************************************************************************************
********************************Installation reussite********************************
*************************************************************************************
*************************************************************************************

******************************************************
Connectez-vous Ã  cette IP sur le poste client : ******
******************************************************

$(ip a)

**********************************************************
Le chemin de votre page web est /var/www/dolibarr ********
**********************************************************
Nom de la BDD   : dolibarr  ******************************
Nom du clients  : DBR1      ******************************
MDP             : btsinfo   ******************************
**********************************************************
"
else
    echo "
*************************************************************************************
*************************************************************************************
********************************Erreur lors de l'installation************************
*************************************************************************************
*************************************************************************************
"
fi
