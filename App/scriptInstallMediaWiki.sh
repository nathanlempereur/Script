#!/bin/bash
echo "
*************************************************************************************
*************************************************************************************
********************************Installation de Apache2 Server***********************
*************************************************************************************
*************************************************************************************
"

./scriptInstallApache2.sh

echo "
*************************************************************************************
*************************************************************************************
********************************Recuperation du MediaWiki****************************
*************************************************************************************
*************************************************************************************
"
apt install -y wget zip

wget https://releases.wikimedia.org/mediawiki/1.44/mediawiki-1.44.2.zip
unzip mediawiki-1.44.2.zip

mv mediawiki-1.44.2/ mediawiki
mv mediawiki/ /var/www

rm mediawiki-1.44.2.zip

if [[ $? -eq 0 ]]; then
    echo "
*************************************************************************************
********************************Extraction vers /var/www/ OK !***********************
*************************************************************************************
"
else
    echo "
*************************************************************************************
********************************Erreur dans l extraction*****************************
*************************************************************************************
"
    exit 0
fi

echo "
*************************************************************************************
*************************************************************************************
********************************Configuration du site********************************
*************************************************************************************
*************************************************************************************
"

a2dissite 000-default.conf

echo "<VirtualHost *:80>

	ServerAdmin webmaster@localhost
	DocumentRoot /var/www/mediawiki


	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

	<Directory /var/www/mediawiki>
		Options Indexes FollowSymLinks
		Require all granted
	</Directory>	
</VirtualHost>" > /etc/apache2/sites-available/mediawiki.conf

a2ensite mediawiki.conf
chown -R www-data:www-data  /var/www/mediawiki/

mysql -u root -e "
CREATE DATABASE mediawiki;
CREATE USER 'MW1'@'localhost' IDENTIFIED BY '@Cest1secret!450';
GRANT ALL PRIVILEGES ON mediawiki.* TO 'MW1'@localhost';"

systemctl restart apache2

if [[ $? -eq 0 ]]; then
    echo "
*************************************************************************************
*************************************************************************************
********************************Installation reussite********************************
*************************************************************************************
*************************************************************************************

******************************************************
Connectez-vous Ã  cette IP sur le poste client : ******
******************************************************

$(ip a)

**********************************************************
Le chemin de votre page web est /var/www/mediawiki *******
**********************************************************
Nom de la BDD   : mediawiki ******************************
Nom du clients  : MW1       ******************************
MDP             : @Cest1secret!450   ******************************
**********************************************************
"
else
    echo "
*************************************************************************************
*************************************************************************************
********************************Erreur lors de l'installation************************
*************************************************************************************
*************************************************************************************
"
fi